---
title: "Mixed models - Interpretation and visualization"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
bibliography: bib.bib
editor_options: 
  chunk_output_type: console
---

<style>
p.caption {
  font-size: 0.8em;
}
</style>

 <script language="javascript"> 
    function toggle(num) {
      var ele = document.getElementById("toggleText" + num);
      var text = document.getElementById("displayText" + num);
      if(ele.style.display == "block") {
        ele.style.display = "none";
        text.innerHTML = "show";
      }
      else {
        ele.style.display = "block";
        text.innerHTML = "hide";
      }
   } 
  </script>
  
# A multiple time-point study

In previous lessons where we used ANCOVA models to account for the baseline we were able to get away with a simple linear model. This because we modeled the change- or post-scores, we did not get any correlated errors (not multiple data points from each participant). The `ten_vs_thirty.xlsx` data set contains three time-points per participant, it is thus not straight forward to put all this data in one model as the data are correlated. As we saw in a previous lesson, not accounting for the correlation in repeated measures studies could affect statistical power.

In this lesson we will model strength data with a linear mixed model (LMM). We will intepret the output and make plots of the model estimates.

A theoretical outcome of the study in this example could look something like in Figure 1 below.

```{r, echo = FALSE,warning = FALSE, message=FALSE, dpi = 300, fig.height = 4, fig.width = 6, fig.align='center'}
library(tidyverse)
colors <- c("#fc8d59", "#ffffbf", "#91bfdb")

line_size <- 1



data.frame(Time = c("Pre", "Mid", "Post"), 
           Strength = c(1, 1, 1)) %>%
  mutate(Time = factor(Time, levels = c("Pre", "Mid", "Post"))) %>%
  ggplot(aes(Time, Strength)) + geom_blank() + 
  scale_y_continuous(limits = c(0, 1)) + 
  
  annotate("segment", x = 1, xend = 2, y = 0.5, yend = 0.8, 
           color = colors[3], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.8, yend = 0.9, 
           color = colors[3], 
           size = line_size) +
  
  annotate("segment", x = 1, xend = 2, y = 0.45, yend = 0.6, 
           color = colors[1], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.6, yend = 0.65, 
           color = colors[1], 
           size = line_size) +

  annotate("text", x = c(2.5, 1.5), y = c(0.4, 0.9), 
           color = c(colors[1], colors[3]), 
           label = c("Group 30RM", "Group 10RM")) +

  theme_minimal() +
  theme(axis.text.y = element_blank()) 


```

The 30RM group starts off at approximately the same level as the 10RM group. After the first period (from Pre to Mid) the 10RM group potentially increases strength more than the 30RM group, the difference could be maintained to the Post time-point.  

Instead of modeling the effect of the baseline on the outcome we could control for it by adjusting the average levels at Mid and Post by removing the differences seen at baseline. This is the basic approach when analyzing repeated measures deigns with mixed models. Before we get to this step we will build the model from the bottom up.

In a first model we do not include any "fixed effects". We only estimate the mean of the whole data set, the very basic model formulation could look some thing like:

$$y = \beta_0$$
In R, we would write this model formula as 

```{r, eval = FALSE}
strength ~ 1
``` 



The data are explained with an intercept only. In the figure below, this model is represented by the black cross.

We could add information about the time-points, still leaving out information regarding the grouping. This model formulation could look something like this:

$$y = \beta_0 + \beta_{Mid} + \beta_{Post}$$
Where $\beta_{Mid}$ is a dummy variable assigned number 1 when time = "mid" otherwise 0, and $\beta_{Post}$ is a dummy variable assigned 1 when time = "post" otherwise 0. This model, given our hypothetical data in this example could look like the black line in the plot below.   

In R, we would write this model formula as 

```{r, eval = FALSE}
strength ~ time
``` 



```{r, echo = FALSE,warning = FALSE, message=FALSE, dpi = 300, fig.height = 4, fig.width = 6, fig.align='center', fig.cap = "Figure 2. Hypothetical model of a study strength development in two groups. The black cross represents a model of the data only modelling the mean, the black line represents a model modelling the average change over time in the two groups. Hypothetical values per group and time are represented in colored lines"}

colors <- c("#fc8d59", "#ffffbf", "#91bfdb")

line_size <- 1



data.frame(Time = c("Pre", "Mid", "Post"), 
           Strength = c(1, 1, 1)) %>%
  mutate(Time = factor(Time, levels = c("Pre", "Mid", "Post"))) %>%
  ggplot(aes(Time, Strength)) + geom_blank() + 
  scale_y_continuous(limits = c(0, 1)) + 
  
  annotate("segment", x = 1, xend = 2, y = 0.5, yend = 0.8, 
           color = colors[3], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.8, yend = 0.9, 
           color = colors[3], 
           size = line_size) +
  
  annotate("segment", x = 1, xend = 2, y = 0.45, yend = 0.6, 
           color = colors[1], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.6, yend = 0.65, 
           color = colors[1], 
           size = line_size) +

  annotate("text", x = c(2.5, 1.5), y = c(0.4, 0.9), 
           color = c(colors[1], colors[3]), 
           label = c("Group 30RM", "Group 10RM")) +

  annotate("point", x = 0.5, y = 0.65, shape = 3, size = 3 ) +

  annotate("segment", x = 1, xend = 2, y = 0.475, yend = 0.7, 
           color = "black", 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.7, yend = 0.65 + 0.125, 
           color = "black", 
           size = line_size) +
  
  
  theme_minimal() +
  theme(axis.text.y = element_blank()) 

```

To account for the difference between groups at baseline we could add an estimate of the effect of baseline differences. In as simplified description this could look like: 

$$y = \beta_0 + \beta_{Group} + \beta_{Mid} + \beta_{Post}$$
Where the additional $\beta_{Group}$ is a dummy variable assigning 1 to all observations in the 30RM group and 0 otherwise. In R we extend the model formulation simply by adding group:

In R, we would write this model formula as 

```{r, eval = FALSE}
strength ~ group + time 
``` 

Estimates from the new model will have one "line" per group representing the average difference between groups at baseline but not accounting for differences in changes over time per group. The two black dashed lines in Figure 3 represents this model. 


```{r, echo = FALSE,warning = FALSE, message=FALSE, dpi = 300, fig.height = 4, fig.width = 6, fig.align='center', fig.cap = "Figure 3. Hypothetical model of a study strength development in two groups. The black cross represents a model of the data only modelling the mean, the solid black line represents a model modelling the average change over time in the two groups. The dashed black lines represents the average change over time with baseline difference between groups at baseline accounted for. Hypothetical values per group and time are represented in colored lines"}

colors <- c("#fc8d59", "#ffffbf", "#91bfdb")

line_size <- 1



data.frame(Time = c("Pre", "Mid", "Post"), 
           Strength = c(1, 1, 1)) %>%
  mutate(Time = factor(Time, levels = c("Pre", "Mid", "Post"))) %>%
  ggplot(aes(Time, Strength)) + geom_blank() + 
  scale_y_continuous(limits = c(0, 1)) + 
  

  
  
  annotate("segment", x = 1, xend = 2, y = 0.5, yend = 0.8, 
           color = colors[3], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.8, yend = 0.9, 
           color = colors[3], 
           size = line_size) +
  
  annotate("segment", x = 1, xend = 2, y = 0.45, yend = 0.6, 
           color = colors[1], 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.6, yend = 0.65, 
           color = colors[1], 
           size = line_size) +

  annotate("text", x = c(2.5, 1.5), y = c(0.4, 0.9), 
           color = c(colors[1], colors[3]), 
           label = c("Group 30RM", "Group 10RM")) +

  annotate("point", x = 0.5, y = 0.65, shape = 3, size = 3 ) +

  annotate("segment", x = 1, xend = 2, y = 0.475, yend = 0.475 + 0.225, 
           color = "black", 
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.475 + 0.225, yend = 0.475 + 0.3, 
           color = "black", 
           size = line_size) +
  
  
    # increase pre mid:
  # 10RM 0.8-0.5 = 0.3
  # 30RM 0.6-0.45 = 0.15
  # Mean increase = 0.225
  
  # increase pre post:
  # 10RM 0.9-0.5 = 0.4
  # 30RM 0.65-0.45 = 0.2
  # Mean increase = 0.3
  

 # 30RM 
    annotate("segment", x = 1, xend = 2, y = 0.45, yend = 0.45 + 0.225, 
           color = "black", lty = 2,
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.45 + 0.225, yend = 0.45 + 0.3, 
           color = "black", lty = 2,
           size = line_size) +
  
 annotate("segment", x = 1, xend = 2, y = 0.5, yend = 0.5 + 0.225, 
           color = "black", 
          lty = 2,
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.5 + 0.225, yend = 0.5 + 0.3, 
           color = "black", lty = 2,
           size = line_size) +
  
  
  
  theme_minimal() +
  theme(axis.text.y = element_blank()) 

```

Notice that the addition of the group term creates two parallel lines representing each group. To fully capture the average changes per group we need to let the model account for different changes per time in each group. We do this by adding an "interaction term". The interaction term allows for each group to have different values at "Mid" and "Post". 

A simplified model formulation could look like this:

$$y = \beta_0 + \beta_{Group} + \beta_{Mid} + \beta_{Post} + \beta_{Mid:Group} + \beta_{Post:Group}$$

In R, we would write this model formula as 

```{r, eval = FALSE}
strength ~ group + time + group:time
``` 

We may also simplify the above formula like this:

```{r, eval = FALSE}
strength ~ group * time 
``` 

The output from this model given our hypothetical data could look like this:

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(knitr)
data.frame(Coefficient = c("Intercept", "TimeMid", "TimePost", 
                           "Group10RM", "TimeMid:Group10RM", "TimePost:Group10RM"), 
           Estimate = c(0.45, 
                        0.15, 
                        0.2, 
                        0.05, 
                        0.15, 
                        0.2)) %>%
  kable()

```

The 30RM group is the reference group so the intercept estimate is the mean in this group at the Pre time point. The 30RM group increases by 0.15 units from Pre to Mid and 0.20 units from Pre to Post. At Pre, the 10RM group is 0.05 units above the 30RM group. Compared to the change seen in the 30RM group, the 10RM group increases an additional 0.15 points Pre to Mid and an additional 0.20 units from Pre to Post. 

To calculate the average in the 30RM group at Mid we can combine estimates from the regression table (above) according to our model formula. Keeping only the terms needed

$$y = \beta_0 + \beta_{Mid} $$
$$y = 0.45 + 0.15$$

$$y = 0.6$$
 The same principles apply if we want to know the estimated mean in the 10RM group at Post, keeping the relevant terms:
 
 
$$y = \beta_0 + \beta_{Group}  + \beta_{Post} + \beta_{Post:Group}$$
$$y=0.45 + 0.05 + 0.2 + 0.2$$
$$y=0.9$$

By adding up the terms in a linear fashion (hence linear regression) we can calculate the estimated averages from both groups. 

The final model allows for different changes over time per group. And different regression estimates will reflect these patterns (Figure 4).

```{r, echo = FALSE,warning = FALSE, message=FALSE, dpi = 300, fig.height = 4, fig.width = 6, fig.align='center', fig.cap = "Figure 4. Hypothetical model of a study on strength development in two groups. The dashed colored lines represents the average change over time per group with baseline difference between groups at baseline accounted for. Regression terms are printed to represent a full interaction model describing the data."}

colors <- c("#fc8d59", "#ffffbf", "#91bfdb")

line_size <- 1

library(latex2exp)

data.frame(Time = c("Pre", "Mid", "Post"), 
           Strength = c(1, 1, 1)) %>%
  mutate(Time = factor(Time, levels = c("Pre", "Mid", "Post"))) %>%
  ggplot(aes(Time, Strength)) + geom_blank() + 
  scale_y_continuous(limits = c(0, 1)) + 
  

  annotate("segment", x = 1, xend = 2, y = 0.5, yend = 0.8, 
           color = colors[3], lty = 2,
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.8, yend = 0.9, 
           color = colors[3], lty = 2,
           size = line_size) +
  
  annotate("segment", x = 1, xend = 2, y = 0.45, yend = 0.6, 
           color = colors[1], lty = 2,
           size = line_size) +
  annotate("segment", x = 2, xend = 3, y = 0.6, yend = 0.65, 
           color = colors[1], lty = 2,
           size = line_size) +

  annotate("text", x = c(2.5, 1.5), y = c(0.4, 0.9), 
           color = c(colors[1], colors[3]), 
           label = c("Group 30RM", "Group 10RM")) +
  # INtercept
  annotate("text", x = 1.2, y = 0.3, label = TeX("$\\beta_0$")) +
  annotate("segment", x = 1.15, y = 0.32, xend = 1, yend = 0.44, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  # Group
  annotate("text", x = 0.75, y = 0.4, label = TeX("$\\beta_{Group}$")) +
  annotate("segment", x = 0.95, xend = 0.95, y = 0.45, yend = 0.5) +
  annotate("segment", x = 0.95, xend = 0.98, y = 0.45, yend = 0.45) +
  annotate("segment", x = 0.95, xend = 0.98, y = 0.5, yend = 0.5) +
  
  annotate("segment", x = 0.75, y = 0.42, xend = 0.94, yend = 0.475, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  
  # Mid 
    annotate("text", x = 2.3, y = 0.48, label = TeX("$\\beta_{Mid}$")) +
  annotate("segment", x = 1, xend = 3, y = 0.45, yend = 0.45, lty = 2) +
  annotate("segment", x = 2, xend = 2, y = 0.45, yend = 0.60, 
           arrow = arrow(angle = 90, length = unit(0.10, "inches"))) +

  annotate("segment", x = 2.2, y = 0.49, xend = 2.05, yend = 0.5, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  # Post
  annotate("text", x = 3.3, y = 0.48, label = TeX("$\\beta_{Post}$")) +

  annotate("segment", x = 3, xend = 3, y = 0.45, yend = 0.65, 
           arrow = arrow(angle = 90, length = unit(0.10, "inches"))) +

  annotate("segment", x = 3.2, y = 0.49, xend = 3.05, yend = 0.5, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  
  # Mid interaction
    annotate("text", x = 2.3, y = 0.7, label = TeX("$\\beta_{Group}+\\beta_{Mid:Group}$")) +

  annotate("segment", x = 2, xend = 2, y = 0.60, yend = 0.80, 
           arrow = arrow(angle = 90, length = unit(0.10, "inches"))) +

  annotate("segment", x = 2.2, y = 0.7, xend = 2.05, yend = 0.75, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  
  # Post interaction
  annotate("text", x = 3.3, y = 0.7, label = TeX("$\\beta_{Group}+\\beta_{Post:Group}$")) +

  annotate("segment", x = 3, xend = 3, y = 0.65, yend = 0.9, 
           arrow = arrow(angle = 90, length = unit(0.10, "inches"))) +

  annotate("segment", x = 3.2, y = 0.7, xend = 3.05, yend = 0.8, 
           arrow = arrow(type = "closed", 
                         length = unit(0.10, "inches"))) +
  
  
  
    # increase pre mid:
  # 10RM 0.8-0.5 = 0.3
  # 30RM 0.6-0.45 = 0.15
  # Mean increase = 0.225
  
  # increase pre post:
  # 10RM 0.9-0.5 = 0.4
  # 30RM 0.65-0.45 = 0.2
  # Mean increase = 0.3
  
  theme_minimal() +
  theme(axis.text.y = element_blank()) 

```

# Inference from a repeated measures study

In the scenario described above the most meaningful comparison between groups are the differences in change over time between groups. This is because....




  
  
  
  
  